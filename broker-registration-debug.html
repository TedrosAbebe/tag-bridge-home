<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Broker Registration Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 3px; }
        input, select { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 3px; width: 200px; }
        pre { background-color: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        .form-group { margin: 10px 0; }
        label { display: inline-block; width: 150px; }
    </style>
</head>
<body>
    <h1>üîß Broker Registration Debug Tool</h1>
    
    <div class="section success">
        <h3>‚úÖ Working Broker Accounts</h3>
        <p>These accounts are confirmed to work:</p>
        <ul>
            <li><strong>testbroker</strong> / password123</li>
            <li><strong>mybroker</strong> / mypassword123 (Just created)</li>
            <li><strong>tedn</strong> / broker123</li>
        </ul>
        <p>Try logging in with any of these accounts first to confirm the system works.</p>
    </div>

    <div class="section">
        <h3>üß™ Test Broker Registration</h3>
        <p>Test the broker registration process with detailed logging:</p>
        
        <div class="form-group">
            <label>Username:</label>
            <input type="text" id="regUsername" value="testuser" placeholder="Enter username">
        </div>
        
        <div class="form-group">
            <label>Password:</label>
            <input type="password" id="regPassword" value="password123" placeholder="Enter password">
        </div>
        
        <div class="form-group">
            <label>Confirm Password:</label>
            <input type="password" id="regConfirmPassword" value="password123" placeholder="Confirm password">
        </div>
        
        <div class="form-group">
            <label>Full Name:</label>
            <input type="text" id="regFullName" value="Test User" placeholder="Enter full name">
        </div>
        
        <div class="form-group">
            <label>Email:</label>
            <input type="email" id="regEmail" value="testuser@example.com" placeholder="Enter email">
        </div>
        
        <div class="form-group">
            <label>Phone:</label>
            <input type="text" id="regPhone" value="+251911000000" placeholder="Enter phone">
        </div>
        
        <div class="form-group">
            <label>Experience:</label>
            <select id="regExperience">
                <option value="1-2">1-2 years</option>
                <option value="3-5" selected>3-5 years</option>
                <option value="5-10">5-10 years</option>
                <option value="10+">10+ years</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>Specialization:</label>
            <select id="regSpecialization">
                <option value="residential" selected>Residential</option>
                <option value="commercial">Commercial</option>
                <option value="industrial">Industrial</option>
                <option value="mixed">Mixed</option>
            </select>
        </div>
        
        <button onclick="testBrokerRegistration()">Test Registration</button>
        <div id="registration-result"></div>
    </div>

    <div class="section">
        <h3>üîç Registration Result</h3>
        <div id="detailed-result">
            <p>Click "Test Registration" above to see detailed results here.</p>
        </div>
    </div>

    <div class="section warning">
        <h3>üö® Common Registration Issues</h3>
        <ol>
            <li><strong>JavaScript Errors:</strong> Check browser console (F12) for errors</li>
            <li><strong>Network Issues:</strong> Check if server is running</li>
            <li><strong>Validation Errors:</strong> Password mismatch, missing fields</li>
            <li><strong>Database Errors:</strong> Username already exists, database locked</li>
            <li><strong>Server Errors:</strong> API endpoint issues</li>
        </ol>
        
        <h4>üí° Solutions:</h4>
        <ul>
            <li>Use simple usernames (no special characters)</li>
            <li>Use strong but simple passwords</li>
            <li>Fill all required fields</li>
            <li>Check browser console for errors</li>
            <li>Try different username if registration fails</li>
        </ul>
    </div>

    <script>
        async function testBrokerRegistration() {
            console.log('üß™ Testing broker registration...');
            
            const resultDiv = document.getElementById('registration-result');
            const detailedDiv = document.getElementById('detailed-result');
            
            resultDiv.innerHTML = '<p>üîÑ Testing registration...</p>';
            detailedDiv.innerHTML = '<p>üîÑ Processing...</p>';

            // Get form data
            const formData = {
                username: document.getElementById('regUsername').value,
                password: document.getElementById('regPassword').value,
                confirmPassword: document.getElementById('regConfirmPassword').value,
                fullName: document.getElementById('regFullName').value,
                email: document.getElementById('regEmail').value,
                phone: document.getElementById('regPhone').value,
                experience: document.getElementById('regExperience').value,
                specialization: document.getElementById('regSpecialization').value
            };

            console.log('Form data:', formData);

            // Validate form
            if (formData.password !== formData.confirmPassword) {
                const errorMsg = '‚ùå Passwords do not match';
                resultDiv.innerHTML = '<div class="error">' + errorMsg + '</div>';
                detailedDiv.innerHTML = '<div class="error">' + errorMsg + '</div>';
                return;
            }

            if (!formData.username || !formData.password || !formData.fullName || !formData.email) {
                const errorMsg = '‚ùå Please fill all required fields';
                resultDiv.innerHTML = '<div class="error">' + errorMsg + '</div>';
                detailedDiv.innerHTML = '<div class="error">' + errorMsg + '</div>';
                return;
            }

            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: formData.username,
                        password: formData.password,
                        role: 'broker',
                        brokerInfo: {
                            fullName: formData.fullName,
                            email: formData.email,
                            phone: formData.phone,
                            licenseNumber: 'TEST' + Date.now(),
                            experience: formData.experience,
                            specialization: formData.specialization
                        }
                    }),
                });

                const data = await response.json();
                console.log('Registration response:', data);

                if (response.ok && data.success) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h4>‚úÖ Registration Successful!</h4>
                            <p><strong>Username:</strong> ${formData.username}</p>
                            <p><strong>Message:</strong> ${data.message}</p>
                        </div>
                    `;
                    
                    detailedDiv.innerHTML = `
                        <div class="success">
                            <h4>‚úÖ Registration Details</h4>
                            <p><strong>Status:</strong> Success</p>
                            <p><strong>Username:</strong> ${data.user.username}</p>
                            <p><strong>Role:</strong> ${data.user.role}</p>
                            <p><strong>Token:</strong> ${data.token ? 'Generated' : 'Not generated'}</p>
                            
                            <h5>üîê Login Credentials:</h5>
                            <ul>
                                <li>Username: <code>${formData.username}</code></li>
                                <li>Password: <code>${formData.password}</code></li>
                            </ul>
                            
                            <h5>üìù Next Steps:</h5>
                            <ol>
                                <li>Go to admin dashboard and approve the broker application</li>
                                <li>Then try logging in with the credentials above</li>
                            </ol>
                            
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            <h4>‚ùå Registration Failed</h4>
                            <p><strong>Error:</strong> ${data.error || data.message}</p>
                        </div>
                    `;
                    
                    detailedDiv.innerHTML = `
                        <div class="error">
                            <h4>‚ùå Registration Error Details</h4>
                            <p><strong>Status:</strong> ${response.status}</p>
                            <p><strong>Error:</strong> ${data.error || data.message}</p>
                            
                            <h5>üîß Possible Solutions:</h5>
                            <ul>
                                <li>Try a different username</li>
                                <li>Check if all fields are filled correctly</li>
                                <li>Ensure password meets requirements</li>
                                <li>Check browser console for JavaScript errors</li>
                            </ul>
                            
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Network error:', error);
                
                const errorMsg = `
                    <div class="error">
                        <h4>üåê Network Error</h4>
                        <p>${error.message}</p>
                        <p>Make sure the development server is running.</p>
                    </div>
                `;
                
                resultDiv.innerHTML = errorMsg;
                detailedDiv.innerHTML = errorMsg;
            }
        }
    </script>
</body>
</html>